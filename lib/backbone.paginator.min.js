(function(a){if("object"==typeof exports&&"function"==typeof require)module.exports=a(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],a);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var b=Backbone.PageableCollection,c=a(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=b,c}}})(function(a,b){"use strict";function c(b,c){if(!a.isNumber(b)||a.isNaN(b)||!a.isFinite(b)||~~b!==b)throw new TypeError("`"+c+"` must be a finite integer");return b}function d(a){for(var b,c,d,e,f,g={},h=decodeURIComponent,j=a.split("&"),m=0,n=j.length;m<n;m++)f=j[m],b=f.split("="),c=b[0],d=b[1],null==d&&(d=!0),c=h(c),d=h(d),e=g[c],o(e)?e.push(d):e?g[c]=[e,d]:g[c]=d;return g}function e(a,b,c){var d=a._events[b];if(d&&d.length){var e=d[d.length-1],f=e.callback;e.callback=function(){try{f.apply(this,arguments),c()}catch(a){throw a}finally{e.callback=f}}}else c()}var f=a.extend,g=a.omit,h=a.clone,j=a.each,k=a.pick,l=a.includes,i=a.isEmpty,m=a.pairs||a.toPairs,n=a.invert,o=a.isArray,p=a.isFunction,q=a.isObject,r=a.keys,s=a.isUndefined,t=Math.ceil,u=Math.floor,v=Math.max,w=b.Collection.prototype,x=/[\s'"]/g,y=/[<>\s'"]/g,z=b.PageableCollection=b.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},constructor:function(a,b){w.constructor.apply(this,arguments),b=b||{};var c=this.mode=b.mode||this.mode||A.mode,d=f({},A.queryParams,this.queryParams,b.queryParams||{});d.directions=f({},A.queryParams.directions,this.queryParams.directions,d.directions),this.queryParams=d;var e=this.state=f({},A.state,this.state,b.state);e.currentPage=null==e.currentPage?e.firstPage:e.currentPage,o(a)||(a=a?[a]:[]),a=a.slice(),"server"==c||null!=e.totalRecords||i(a)||(e.totalRecords=this.length),this.switchMode(c,f({fetch:!1,resetState:!1,models:a},b));var g=b.comparator;if(e.sortKey&&!g&&this.setSorting(e.sortKey,e.order,b),"server"!=c){var j=this.fullCollection;g&&b.full&&(this.comparator=null,j.comparator=g),b.full&&j.sort(),i(a)||this.getPage(e.currentPage)}this._initState=h(this.state)},_makeFullCollection:function(a,c){var d,e,f,g=["url","model","sync","comparator"],h=this.constructor.prototype,j={};for(d=0,e=g.length;d<e;d++)f=g[d],s(h[f])||(j[f]=h[f]);var k=new(b.Collection.extend(j))(a,c);for(d=0,e=g.length;d<e;d++)f=g[d],this[f]!==h[f]&&(k[f]=this[f]);return k},_makeCollectionEventHandler:function(a,b){return function(c,d,g,i){var k=a._handlers;j(r(k),function(c){var d=k[c];a.off(c,d),b.off(c,d)});var l=h(a.state),m=l.firstPage,n=0===m?l.currentPage:l.currentPage-1,o=l.pageSize,p=n*o,q=p+o;if("add"==c){var u,v,w,x,i=i||{};if(g==b)v=b.indexOf(d),v>=p&&v<q&&(x=a,u=w=v-p);else{u=a.indexOf(d),v=p+u,x=b;var w=s(i.at)?v:i.at+p}if(i.onRemove||(++l.totalRecords,delete i.onRemove),a.state=a._checkState(l),x){x.add(d,f({},i,{at:w}));var y=u>=o?d:!s(i.at)&&w<q&&a.length>o?a.at(o):null;y&&e(g,c,function(){a.remove(y,{onAdd:!0})})}i.silent||a.trigger("pageable:state:change",a.state)}if("remove"==c){if(!i.onAdd){if(! --l.totalRecords)l.totalRecords=null,l.totalPages=null;else{var z=l.totalPages=t(l.totalRecords/o);l.lastPage=0===m?z-1:z||m,l.currentPage>z&&(l.currentPage=l.lastPage)}a.state=a._checkState(l);var A,B=i.index;g==a?((A=b.at(q))?e(a,c,function(){a.push(A,{onRemove:!0})}):!a.length&&l.totalRecords&&a.reset(b.models.slice(p-o,q-o),f({},i,{parse:!1})),b.remove(d)):B>=p&&B<q&&((A=b.at(q-1))&&e(a,c,function(){a.push(A,{onRemove:!0})}),a.remove(d),!a.length&&l.totalRecords&&a.reset(b.models.slice(p-o,q-o),f({},i,{parse:!1})))}else delete i.onAdd;i.silent||a.trigger("pageable:state:change",a.state)}if("reset"==c){if(i=g,g=d,g==a&&null==i.from&&null==i.to){var C=b.models.slice(0,p),D=b.models.slice(p+a.models.length);b.reset(C.concat(a.models).concat(D),i)}else g==b&&((l.totalRecords=b.models.length)||(l.totalRecords=null,l.totalPages=null),"client"==a.mode&&(m=l.lastPage=l.currentPage=l.firstPage,n=0===m?l.currentPage:l.currentPage-1,p=n*o,q=p+o),a.state=a._checkState(l),a.reset(b.models.slice(p,q),f({},i,{parse:!1})));i.silent||a.trigger("pageable:state:change",a.state)}"sort"==c&&(i=g,g=d,g===b&&a.reset(b.models.slice(p,q),f({},i,{parse:!1}))),j(r(k),function(c){var d=k[c];j([a,b],function(a){a.on(c,d);var b=a._events[c]||[];b.unshift(b.pop())})})}},_checkState:function(a){var b=this.mode,d=this.links,e=a.totalRecords,f=a.pageSize,g=a.currentPage,h=a.firstPage,i=a.totalPages;if(null!=e&&null!=f&&null!=g&&null!=h&&("infinite"!=b||d)){if(e=c(e,"totalRecords"),f=c(f,"pageSize"),g=c(g,"currentPage"),h=c(h,"firstPage"),1>f)throw new RangeError("`pageSize` must be >= 1");if(i=a.totalPages=t(e/f),0>h||1<h)throw new RangeError("`firstPage must be 0 or 1`");if(a.lastPage=0===h?v(0,i-1):i||h,"infinite"==b){if(!d[g])throw new RangeError("No link found for page "+g);}else if(g<h||0<i&&(h?g>i:g>=i))throw new RangeError("`currentPage` must be firstPage <= currentPage "+(h?"<":"<=")+" totalPages if "+h+"-based. Got "+g+".")}return a},setPageSize:function(a,b){a=c(a,"pageSize"),b=b||{first:!1};var d=this.state,e=t(d.totalRecords/a),h=e?v(d.firstPage,u(e*d.currentPage/d.totalPages)):d.firstPage;return d=this.state=this._checkState(f({},d,{pageSize:a,currentPage:b.first?d.firstPage:h,totalPages:e})),this.getPage(d.currentPage,g(b,["first"]))},switchMode:function(b,c){if(!l(["server","client","infinite"],b))throw new TypeError("`mode` must be one of \"server\", \"client\" or \"infinite\"");c=c||{fetch:!0,resetState:!0};var d=this.state=c.resetState?h(this._initState):this._checkState(f({},this.state));this.mode=b;var e,k=this,m=this.fullCollection,n=this._handlers=this._handlers||{};if("server"!=b&&!m){m=this._makeFullCollection(c.models||[],c),m.pageableCollection=this,this.fullCollection=m;var o=this._makeCollectionEventHandler(this,m);j(["add","remove","reset","sort"],function(b){n[b]=e=a.bind(o,{},b),k.on(b,e),m.on(b,e)}),m.comparator=this._fullComparator}else"server"==b&&m&&(j(r(n),function(a){e=n[a],k.off(a,e),m.off(a,e)}),delete this._handlers,this._fullComparator=m.comparator,delete this.fullCollection);if("infinite"==b)for(var p=this.links={},q=d.firstPage,s=t(d.totalRecords/d.pageSize),u=0===q?v(0,s-1):s||q,w=d.firstPage;w<=u;w++)p[w]=this.url;else this.links&&delete this.links;return c.silent||this.trigger("pageable:state:change",d),c.fetch?this.fetch(g(c,"fetch","resetState")):this},hasPreviousPage:function(){var a=this.state,b=a.currentPage;return"infinite"==this.mode?!!this.links[b-1]:b>a.firstPage},hasNextPage:function(){var a=this.state,b=this.state.currentPage;return"infinite"==this.mode?!!this.links[b+1]:b<a.lastPage},getFirstPage:function(a){return this.getPage("first",a)},getPreviousPage:function(a){return this.getPage("prev",a)},getNextPage:function(a){return this.getPage("next",a)},getLastPage:function(a){return this.getPage("last",a)},getPage:function(a,b){var d=this.mode,e=this.fullCollection;b=b||{fetch:!1};var h=this.state,j=h.firstPage,k=h.currentPage,l=h.lastPage,m=h.pageSize,n=a;n="first"===a?j:"prev"===a?k-1:"next"===a?k+1:"last"===a?l:c(a,"index"),this.state=this._checkState(f({},h,{currentPage:n})),b.silent||this.trigger("pageable:state:change",this.state),b.from=k,b.to=n;var o=(0===j?n:n-1)*m,p=e&&e.length?e.models.slice(o,o+m):[];return"client"!=d&&("infinite"!=d||i(p))||b.fetch?("infinite"==d&&(b.url=this.links[n]),this.fetch(g(b,"fetch"))):(this.reset(p,g(b,"fetch")),this)},getPageByOffset:function(a,b){if(0>a)throw new RangeError("`offset must be > 0`");a=c(a,"offset");var d=u(a/this.state.pageSize);return 0!==this.state.firstPage&&d++,d>this.state.lastPage&&(d=this.state.lastPage),this.getPage(d,b)},sync:function(a,c,d){var e=this;if("infinite"==e.mode){var g=d.success,h=e.state.currentPage;d.success=function(a,b,c){var i=e.links,j=e.parseLinks(a,f({xhr:c},d));j.first&&(i[e.state.firstPage]=j.first),j.prev&&(i[h-1]=j.prev),j.next&&(i[h+1]=j.next),g&&g(a,b,c)}}return(w.sync||b.sync).call(e,a,c,d)},parseLinks:function(a,b){var c={},d=b.xhr.getResponseHeader("Link");if(d){var e=["first","prev","next"];j(d.split(","),function(a){var b=a.split(";"),d=b[0].replace(y,""),f=b.slice(1);j(f,function(a){var b=a.split("="),f=b[0].replace(x,""),g=b[1].replace(x,"");"rel"==f&&l(e,g)&&(c[g]=d)})})}return c},parse:function(a,b){var c=this.parseState(a,h(this.queryParams),h(this.state),b);return c&&(this.state=this._checkState(f({},this.state,c)),!(b||{}).silent&&this.trigger("pageable:state:change",this.state)),this.parseRecords(a,b)},parseState:function(b,c,d){if(b&&2===b.length&&q(b[0])&&o(b[1])){var e=h(d),f=b[0];return j(m(g(c,"directions")),function(b){var c=b[0],d=b[1],g=f[d];s(g)||a.isNull(g)||(e[c]=f[d])}),f.order&&(e.order=1*n(c.directions)[f.order]),e}},parseRecords:function(a){return a&&2===a.length&&q(a[0])&&o(a[1])?a[1]:a},fetch:function(b){b=b||{};var c=this._checkState(this.state),e=this.mode;"infinite"!=e||b.url||(b.url=this.links[c.currentPage]);var h=b.data||{},l=b.url||this.url||"";p(l)&&(l=l.call(this));var n=l.indexOf("?");-1!=n&&(f(h,d(l.slice(n+1))),l=l.slice(0,n)),b.url=l,b.data=h;var q="client"==this.mode?k(this.queryParams,"sortKey"):g(k(this.queryParams,r(A.queryParams)),"order","directions","totalPages","totalRecords");j(q,function(b,d){b=p(b)?b.call(this):b,null!=c[d]&&null!=b&&a.isUndefined(h[b])&&(h[b]=c[d])},this);var t=p(this.queryParams.sortKey)?this.queryParams.sortKey.call(this):this.queryParams.sortKey,u=p(this.queryParams.order)?this.queryParams.order.call(this):this.queryParams.order;if(null!=t&&null!=c.sortKey&&null!=u&&null!=c.order)if(o(c.order)){h[u]=[];for(var x=0;x<c.order.length;x++)h[u].push(this.queryParams.directions[c.order[x]])}else h[u]=this.queryParams.directions[c.order+""];for(var y=m(g(this.queryParams,r(A.queryParams))),x=0;x<y.length;x++){var z=y[x],B=z[1];B=p(B)?B.call(this):B,null!=B&&(h[z[0]]=B)}if("server"!=e){var C=this,D=this.fullCollection,E=b.success;return b.success=function(a,c,d){d=d||{},s(b.silent)?delete d.silent:d.silent=b.silent;var g=a.models;"client"==e?D.reset(g,d):(D.add(g,f({at:D.length},f(d,{parse:!1}))),C.trigger("reset",C,d)),E&&E(a,c,d)},w.fetch.call(this,f({},b,{silent:!0}))}return w.fetch.call(this,b)},_makeComparator:function(a,b,c){var d=this.state;if(a=a||d.sortKey,b=b||d.order,a&&b)return c||(c=function(a,b){return a.get(b)}),function(d,e){var f,g=c(d,a),h=c(e,a);return(1===b&&(f=g,g=h,h=f),g===h)?0:g<h?-1:1}},setSorting:function(a,b,c){var d=this.state;d.sortKey=a,d.order=b=b||d.order;var e=this.fullCollection,g=!1,h=!1;a||(g=h=!0);var i=this.mode;c=f({side:"client"==i?i:"server",full:!0},c);var j=this._makeComparator(a,b,c.sortValue),k=c.full,l=c.side;return"client"==l?k?(e&&(e.comparator=j),g=!0):(this.comparator=j,h=!0):"server"==l&&!k&&(this.comparator=j),g&&(this.comparator=null),h&&e&&(e.comparator=null),this}}),A=z.prototype;return z});
